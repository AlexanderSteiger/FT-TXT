# This file is a template, and might need editing before it works on your project.
# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options

# you can delete this line if you're not using Docker
image: debian:stable

stages:
  - build1
  - build2
  - build3

before_script:
  - apt-get update -qq
  - cd /builds/fischertechnik/FT-TXT
  - ./Linux-Pakete-Required.sh
  - env DEBIAN_FRONTEND=noninteractive  ./Linux-Pakete-Extra.sh
  - apt-get -y install joe git gitk cvs wget cpio -qq

after_script:
  - echo "END"

make:bootloader:
  stage: build1
  script:
    - mkdir /opt/FT
    - chmod a+rw /opt/FT
    - cd /builds/fischertechnik/FT-TXT
    - ./Make-TXT-Bootloader.sh > Make-TXT-Bootloader.sh.log
  artifacts:
    name: "u-boot"
    paths:
    - /builds/fischertechnik/u-boot/
    expire_in: 1 week
  after_script:
    - ls -la /builds/fischertechnik/u-boot/
    
make:buildroot:
  stage: build2
  script:
    - cd /builds/fischertechnik/FT-TXT
    - ./Make-TXT-Buildroot-Clean.sh > Make-TXT-Buildroot-Clean.sh.log
  artifacts:
    name: "buildroot"
    paths:
    - /builds/fischertechnik/buildroot/
    expire_in: 1 week
  dependencies:
    - make:bootloader
  after_script:
    - ls -la /builds/fischertechnik/buildroot/
    
make:image:
  stage: build3
  script:
    - cd /builds/fischertechnik/FT-TXT
    - ./Make-TXT-Image.sh
  artifacts:
    name: "image"
    paths:
    - /builds/fischertechnik/
    - /builds/fischertechnik/ft-TXT_Build_$BUILD.img.zip
    expire_in: 1 week
  dependencies:
    - make:buildroot
  after_script:
    - ls -la /builds/fischertechnik/
    - export BUILD=`cat /builds/fischertechnik/FT-TXT/board/FT/TXT/BUILD`

make:update:
  stage: build3
  script:
    - mkdir /builds/fischertechnik/update
    - cd /builds/fischertechnik/FT-TXT
    - ./Make-TXT-UpdateScripts.sh
  artifacts:
    name: "update"
    paths:
      - /builds/fischertechnik/update/
    expire_in: 1 week
  dependencies:
    - make:buildroot
  after_script:
    - ls -la /builds/fischertechnik/update/

make:graphs:
  stage: build3
  before_script:
    - apt-get -y install graphviz python-matplotlib python-numpy -qq
  script:
    - cd /builds/fischertechnik/buildroot
    - make graph-depends
    - make graph-build
    - make graph-size
  dependencies:
    - make:buildroot
  artifacts:
    name: "graphs"
    paths:
      - /builds/fischertechnik/buildroot/output/graphs/
  after_script:
    - ls -la /builds/fischertechnik/buildroot/output/graphs/
